## üî• FRESH START - COMPLETE SETUP GUIDE

**Everything is broken? Start fresh!**

This guide will help you set up everything from scratch in **30 minutes**.

---

## üéØ WHAT WE'RE FIXING

The issues you had:
- ‚úÖ Session not persisting on refresh
- ‚úÖ Login redirects not working  
- ‚úÖ Photo uploads failing
- ‚úÖ Activity logs not showing
- ‚úÖ Everything getting reset

**ALL FIXED IN THIS GUIDE!**

---

## üìã STEP-BY-STEP SETUP (30 minutes)

### ‚òëÔ∏è STEP 1: Create New Supabase Project (5 mins)

1. Go to: **https://supabase.com/dashboard**
2. Click **"New Project"**
3. Fill in:
   - **Name:** PLV Lost and Found
   - **Database Password:** (Create a STRONG password and SAVE IT!)
   - **Region:** Singapore or Tokyo
4. Click **"Create new project"**
5. **WAIT** 2-3 minutes until project is ready ‚úÖ

---

### ‚òëÔ∏è STEP 2: Get Your API Keys (2 mins)

1. Click **"Project Settings"** (‚öôÔ∏è icon in sidebar)
2. Click **"API"**
3. Copy these TWO things:

**A. Project URL:**
```
https://YOUR_PROJECT_ID.supabase.co
```
- Copy just the `YOUR_PROJECT_ID` part
- Example: `abcdefghijk123456`

**B. anon/public key:**
```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```
- Copy the FULL key (it's very long!)

4. **Update your project:**
   - Open `/utils/supabase/info.tsx`
   - Replace with YOUR keys:

```typescript
/* AUTOGENERATED FILE - DO NOT EDIT CONTENTS */

export const projectId = "YOUR_PROJECT_ID_HERE"
export const publicAnonKey = "YOUR_FULL_ANON_KEY_HERE"
```

5. **SAVE THE FILE!** ‚ö†Ô∏è

---

### ‚òëÔ∏è STEP 3: Set Up Database (5 mins)

1. In Supabase Dashboard, click **"SQL Editor"**
2. Click **"New query"**
3. **In your project**, open `/lib/supabase/complete-setup.sql`
4. **COPY EVERYTHING** from that file (the entire file!)
5. **PASTE** into Supabase SQL Editor
6. Click **"Run"** (‚ñ∂Ô∏è button at bottom right)

**Expected Result:**
```
Success. No rows returned
status: "Database setup complete! ‚úÖ"
```

**‚úÖ This creates:**
- All 5 database tables
- All security policies (RLS)
- Helper functions
- Indexes for performance

**Verify it worked:**
1. Click **"Table Editor"** in sidebar
2. You should see 5 tables:
   - users
   - lost_items
   - claims
   - activity_logs
   - otp_codes

---

### ‚òëÔ∏è STEP 4: Create Storage Buckets (5 mins)

**Bucket 1: Item Photos**

1. Click **"Storage"** in left sidebar
2. Click **"Create a new bucket"**
3. Fill in:
   - **Name:** `lost-item-images`
   - **Public bucket:** ‚úÖ **CHECK THIS!**
4. Click **"Create bucket"**

**Bucket 2: Claim Proofs**

5. Click **"Create a new bucket"** again
6. Fill in:
   - **Name:** `claim-proofs`
   - **Public bucket:** ‚úÖ **CHECK THIS!**
7. Click **"Create bucket"**

**Set Storage Policies (IMPORTANT for uploads!):**

8. Click on **"lost-item-images"** bucket
9. Click **"Policies"** tab
10. Click **"New Policy"**
11. Click **"For full customization"**
12. Fill in:
    - **Policy name:** `Allow authenticated uploads`
    - **Allowed operation:** `INSERT`
    - **Policy definition:** 
    ```sql
    authenticated
    ```
13. Click **"Review"** then **"Save policy"**

14. Create another policy:
    - **Policy name:** `Allow public reads`
    - **Allowed operation:** `SELECT`
    - **Policy definition:**
    ```sql
    true
    ```
15. Click **"Review"** then **"Save policy"**

16. **REPEAT steps 8-15** for the **"claim-proofs"** bucket

**Quick verification:**
- Both buckets show (Public) next to their names
- Each bucket has 2 policies (uploads + reads)

---

### ‚òëÔ∏è STEP 5: Configure Authentication (3 mins)

**Disable Email Confirmation (for testing):**

1. Click **"Authentication"** in sidebar
2. Click **"Providers"**
3. Find **"Email"** provider, click to expand
4. Find **"Confirm email"** toggle
5. **TURN IT OFF** (disable it)
6. Click **"Save"**

**Set Redirect URLs:**

7. Click **"URL Configuration"** (under Authentication)
8. Scroll to **"Redirect URLs"**
9. Add these URLs one by one:
   ```
   http://localhost:5173
   http://localhost:5173/#type=signup
   http://localhost:5173/#type=recovery
   ```
10. Click **"Save"**

---

### ‚òëÔ∏è STEP 6: Create Admin Account (5 mins)

1. Go to **"SQL Editor"** ‚Üí **"New query"**
2. **COPY THIS SQL** (edit the marked fields):

```sql
DO $$
DECLARE
  new_user_id UUID;
BEGIN
  -- Create auth user
  INSERT INTO auth.users (
    instance_id,
    id,
    aud,
    role,
    email,
    encrypted_password,
    email_confirmed_at,
    recovery_sent_at,
    last_sign_in_at,
    raw_app_meta_data,
    raw_user_meta_data,
    created_at,
    updated_at,
    confirmation_token,
    email_change,
    email_change_token_new,
    recovery_token
  ) VALUES (
    '00000000-0000-0000-0000-000000000000',
    gen_random_uuid(),
    'authenticated',
    'authenticated',
    'admin@plv.edu.ph',  -- ‚ö†Ô∏è CHANGE THIS
    crypt('Admin123!', gen_salt('bf')),  -- ‚ö†Ô∏è CHANGE PASSWORD
    NOW(),
    NOW(),
    NOW(),
    '{"provider":"email","providers":["email"]}',
    '{}',
    NOW(),
    NOW(),
    '',
    '',
    '',
    ''
  )
  RETURNING id INTO new_user_id;

  -- Create user profile
  INSERT INTO public.users (
    auth_id, 
    email, 
    full_name, 
    student_id, 
    contact_number, 
    role, 
    is_verified, 
    status
  )
  VALUES (
    new_user_id,
    'admin@plv.edu.ph',  -- ‚ö†Ô∏è SAME EMAIL AS ABOVE
    'Admin User',         -- ‚ö†Ô∏è CHANGE TO YOUR NAME
    'ADMIN-001',          
    '09123456789',        -- ‚ö†Ô∏è CHANGE TO YOUR NUMBER
    'admin',
    true,
    'active'
  );
  
  RAISE NOTICE 'Admin user created successfully!';
END $$;
```

3. **EDIT THESE FIELDS:**
   - Line 20: Your email (must be @plv.edu.ph)
   - Line 21: Your password (min 8 characters)
   - Line 37: Same email as line 20
   - Line 38: Your full name
   - Line 40: Your contact number

4. Click **"Run"** (‚ñ∂Ô∏è)

**Expected Result:**
```
Success. No rows returned
NOTICE: Admin user created successfully!
```

**Save your login info:**
```
Email: _______________________
Password: _____________________
```

**Verify it worked:**
1. Click **"Table Editor"** ‚Üí **"users"**
2. You should see 1 row with your admin account
3. Check: role = 'admin', status = 'active', is_verified = true

---

### ‚òëÔ∏è STEP 7: Test Everything (5 mins)

**Test 1: Start Your App**

1. Open terminal in your project folder
2. Run: `npm run dev`
3. App should start with no errors
4. Open: `http://localhost:5173`

**Test 2: Admin Login**

1. Click **"Log In"**
2. Enter your admin email and password
3. Click **"Log In"**

**Expected:**
- ‚úÖ Login successful
- ‚úÖ See Admin Dashboard
- ‚úÖ No errors in console (press F12 to check)

**Test 3: Session Persistence**

1. While logged in as admin, press **F5** to refresh
2. **Expected:** You should STAY logged in and see Admin Dashboard
3. ‚úÖ If this works, session persistence is fixed!

**Test 4: Register Student Account**

1. Log out (click your name ‚Üí Logout)
2. Click **"Get Started"** ‚Üí **"Sign Up"**
3. Fill in form with @plv.edu.ph email
4. Click **"Sign Up"**
5. **Expected:** "Account created!" message
6. Check your email for verification link (if you enabled confirmation)

**Test 5: Student Login**

1. Log in with student account
2. **Expected:** See Lost & Found Board
3. Press F5 to refresh
4. **Expected:** Still logged in on Board page ‚úÖ

**Test 6: Upload Photo**

1. While logged in as student, click **"Report Item"**
2. Fill in form and upload a photo
3. Click **"Report Item"**
4. **Expected:** Item reported successfully!
5. **Verify upload worked:**
   - Go to Supabase ‚Üí Storage ‚Üí lost-item-images
   - Should see uploaded photo in "items" folder

**Test 7: Admin Verification**

1. Log out, log back in as admin
2. See pending item in dashboard
3. Click **"Verify"**
4. **Expected:** Item verified!

**Test 8: Activity Logs**

1. As admin, check if you see activity logs
2. Should see:
   - "Item reported" log
   - "Item verified" log
3. ‚úÖ Activity logs working!

---

## ‚úÖ CHECKLIST - Did Everything Work?

- [ ] Supabase project created
- [ ] API keys updated in /utils/supabase/info.tsx
- [ ] Database setup SQL ran successfully
- [ ] 5 tables exist in Table Editor
- [ ] 2 storage buckets created (both public)
- [ ] Storage policies set for both buckets
- [ ] Email confirmation disabled
- [ ] Redirect URLs added
- [ ] Admin account created
- [ ] Admin login works
- [ ] Session persists on refresh ‚≠ê
- [ ] Student registration works
- [ ] Student login works
- [ ] Photo upload works ‚≠ê
- [ ] Item reporting works
- [ ] Admin verification works
- [ ] Activity logs showing ‚≠ê

---

## üÜò TROUBLESHOOTING

### Problem: "Invalid API key"
**Fix:** 
1. Check `/utils/supabase/info.tsx`
2. Make sure projectId and publicAnonKey are YOUR values
3. Restart dev server: `Ctrl+C` then `npm run dev`

### Problem: Can't login / "Invalid credentials"
**Fix:**
1. Go to Supabase ‚Üí Authentication ‚Üí Users
2. Check if user exists
3. If yes, try resetting password
4. If no, recreate admin user with SQL from Step 6

### Problem: Refresh page kicks me out
**Fix:**
1. This should be FIXED by the new AppContext
2. If still happening:
   - Check browser console for errors (F12)
   - Check if `loading` state is working
   - Try clearing browser cache (Ctrl+Shift+Delete)

### Problem: Can't upload photos
**Fix:**
1. Go to Storage ‚Üí Click bucket ‚Üí Policies
2. Make sure you have these 2 policies:
   - "Allow authenticated uploads" (INSERT)
   - "Allow public reads" (SELECT)
3. Make sure bucket is PUBLIC
4. If still failing, check browser console for exact error

### Problem: Activity logs not showing
**Fix:**
1. Go to SQL Editor
2. Run this to check if policies work:
```sql
SELECT * FROM activity_logs;
```
3. If it returns rows, frontend is the issue
4. If it says "permission denied", run complete-setup.sql again

### Problem: Session not persisting still!
**Fix:**
1. Clear ALL browser data:
   - Press F12
   - Go to Application tab
   - Clear Storage ‚Üí Clear site data
2. Close browser completely
3. Reopen and try again
4. Check if cookies are enabled

### Problem: Tables don't exist
**Fix:**
1. Go to SQL Editor
2. Re-run `/lib/supabase/complete-setup.sql`
3. Wait for "Database setup complete! ‚úÖ" message

---

## üéâ SUCCESS!

If all checklist items are ‚úÖ, congratulations! Your system is fully set up and working!

**What you now have:**
- ‚úÖ Working authentication (login/signup/logout)
- ‚úÖ Session persistence (no more refresh issues!)
- ‚úÖ Photo uploads (items & claim proofs)
- ‚úÖ Activity logs (for admin and users)
- ‚úÖ Lost & Found Board
- ‚úÖ Claim system
- ‚úÖ Admin dashboard
- ‚úÖ Full role-based access control

---

## üìù NEXT STEPS

Now that everything works, you can:

1. **Create more admin accounts**
   - Use Admin Management in dashboard
   - Or re-run Step 6 SQL with different email

2. **Test full workflow**
   - Student reports item
   - Admin verifies item
   - Different student claims item
   - Admin approves claim

3. **Customize**
   - Update item types
   - Add more locations
   - Customize email templates

4. **Deploy to production**
   - When ready, see deployment guide
   - Update redirect URLs in Supabase
   - Enable email confirmation

---

## üíæ BACKUP YOUR SETUP

**Save these somewhere safe:**

1. **Supabase credentials:**
   - Project ID: _______________
   - anon key: _______________
   - Database password: _______________

2. **Admin login:**
   - Email: _______________
   - Password: _______________

3. **Project URL:**
   - https://_____________.supabase.co

---

**üéä You're all set! Everything should work now!**

If you have any issues, check the Troubleshooting section above or check browser console (F12) for specific error messages.
